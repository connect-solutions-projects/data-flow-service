<div class="content-page">
  <h1>Arquitetura Técnica Detalhada — DataFlow</h1>

  <h2>1. Visão Geral</h2>

  <p>DataFlow é uma plataforma de ingestão assíncrona construída em .NET 9, organizada em um monorepo (um único repositório contendo todos os serviços e bibliotecas). O objetivo é receber arquivos de grande porte, processá-los em background, expor métricas/relatórios e simplificar a operação através de uma stack containerizada (Docker Compose).</p>

  <p>A arquitetura segue princípios de separação por camadas, comunicação assíncrona via fila e observabilidade nativa.</p>

  <h2>2. Organização do Monorepo</h2>

  <p>Adotamos um monorepo porque todos os serviços compartilham o mesmo conjunto de domínios, contratos e utilitários.</p>

  <pre><code>src/
  apps/
    DataFlow.Api/
    DataFlow.Worker/
    DataFlow.ReportingService/
  libs/
    DataFlow.Core.Domain/
    DataFlow.Core.Application/
    DataFlow.Infrastructure/
    DataFlow.Observability/
    DataFlow.Shared/</code></pre>

  <h3>2.1 Benefícios do monorepo</h3>
  <ul>
    <li><strong>Refatorações coordenadas:</strong> alterações no domínio ou contratos são propagadas para API, Worker e Reporting numa única PR.</li>
    <li><strong>Builds e testes integrados:</strong> pipelines conseguem validar todos os projetos simultaneamente.</li>
    <li><strong>Reuso explícito:</strong> bibliotecas compartilhadas residem no mesmo repositório.</li>
    <li><strong>Governança uniforme:</strong> lint, estilos, scripts e documentação vivem lado a lado.</li>
  </ul>

  <h2>3. Serviços e Responsabilidades</h2>

  <table>
    <thead>
      <tr>
        <th>Serviço</th>
        <th>Função</th>
        <th>Tecnologia</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>DataFlow.Api</code></td>
        <td>Recebe uploads, valida, publica mensagens no RabbitMQ</td>
        <td>ASP.NET Core Minimal API (.NET 9), MassTransit</td>
      </tr>
      <tr>
        <td><code>DataFlow.Worker</code></td>
        <td>Consome mensagens da fila, processa arquivos</td>
        <td>Worker Service (.NET 9) + MassTransit</td>
      </tr>
      <tr>
        <td><code>DataFlow.ReportingService</code></td>
        <td>Gera relatórios a partir de métricas Prometheus</td>
        <td>ASP.NET Core Minimal API</td>
      </tr>
    </tbody>
  </table>

  <h2>4. Fluxo de Ingestão Detalhado</h2>

  <ol>
    <li><strong>Upload</strong> (<code>POST /ingestion/jobs</code>): cliente envia arquivo via multipart com metadados.</li>
    <li><strong>Validações rápidas</strong> na API: rate limiting, deduplicação por checksum, registro do job.</li>
    <li><strong>Publicação</strong>: MassTransit envia <code>ProcessJobMessage</code> para RabbitMQ.</li>
    <li><strong>Processamento</strong> (Worker): consome mensagem, abre arquivo, conta registros, aplica validações.</li>
    <li><strong>Observabilidade</strong>: API e Worker publicam métricas/traces via OpenTelemetry.</li>
    <li><strong>Relatórios</strong>: ReportingService consulta Prometheus e gera relatórios.</li>
  </ol>

  <h2>5. Camadas e Bibliotecas Compartilhadas</h2>

  <ul>
    <li><strong>DataFlow.Core.Domain:</strong> Entidades, agregados, enums, eventos, exceções</li>
    <li><strong>DataFlow.Core.Application:</strong> Handlers (MediatR), comandos/queries, orchestrators</li>
    <li><strong>DataFlow.Infrastructure:</strong> EF Core, Redis, RabbitMQ, parsers</li>
    <li><strong>DataFlow.Observability:</strong> Métricas customizadas e instrumentação</li>
    <li><strong>DataFlow.Shared:</strong> Contratos/mensagens compartilhadas</li>
  </ul>

  <h2>6. Containerização e Proxy</h2>

  <p>Docker Compose organiza serviços em perfis (<code>api</code>, <code>worker</code>, <code>reporting</code>, <code>proxy</code>).</p>

  <p>Proxy Nginx expõe:</p>
  <ul>
    <li><code>https://api.local:8443/*</code> → API</li>
    <li><code>https://reporting.local:8444/*</code> → Reporting</li>
  </ul>

  <h2>7. Observabilidade</h2>

  <ul>
    <li><strong>OpenTelemetry:</strong> <code>AddDataFlowTelemetry</code> registra métricas, traces e logging</li>
    <li><strong>Prometheus:</strong> scrapes do OTel Collector, expõe consultas</li>
    <li><strong>Grafana:</strong> dashboards + Image Renderer</li>
    <li><strong>Relatórios:</strong> ReportingService orquestra Prometheus + Grafana para gerar documentos</li>
  </ul>

  <p><em>Para mais detalhes, consulte o documento original em Markdown: <code>docs/architecture/dataflow-technical-architecture.md</code></em></p>
</div>

