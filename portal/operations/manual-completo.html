<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual de Instalação, Implantação e Testes - DataFlow</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .content-page {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            max-width: 960px;
        }
        .content-page h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #333;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 1rem;
        }
        .content-page h2 {
            font-size: 2rem;
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            color: #667eea;
        }
        .content-page h3 {
            font-size: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 0.75rem;
            color: #333;
        }
        .content-page p {
            margin-bottom: 1rem;
            color: #666;
            line-height: 1.8;
        }
        .content-page ul,
        .content-page ol {
            margin-left: 2rem;
            margin-bottom: 1.5rem;
            color: #666;
        }
        .content-page li {
            margin-bottom: 0.5rem;
        }
        .content-page code {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .content-page pre {
            background: #0a0e1a;
            border: 1px solid #1f2a44;
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
            margin: 1.5rem 0;
        }
        .content-page pre code {
            background: transparent;
            color: #e2e8f0;
            padding: 0;
        }
        .content-page blockquote {
            border-left: 4px solid #667eea;
            background: rgba(102, 126, 234, 0.08);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: #475569;
            margin: 1.5rem 0;
        }
    </style>
</head>
<body class="docs-page">
    <header class="header">
        <nav class="nav container">
            <div class="header-brand">
                <a href="../index.html" class="logo">
                    <i class="fas fa-project-diagram"></i>
                    DataFlow
                </a>
            </div>
            <ul class="nav-links">
                <li><a href="../index.html#home">Início</a></li>
                <li><a href="../index.html#arquitetura">Arquitetura</a></li>
                <li><a href="../index.html#operacoes">Operações</a></li>
                <li><a href="../index.html#tutoriais">Tutoriais</a></li>
                <li><a href="../index.html#links">Links</a></li>
            </ul>
            <button class="mobile-menu-toggle" aria-label="Menu">
                <i class="fas fa-bars"></i>
            </button>
        </nav>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="content-page">
                <h1>Manual de Instalação, Implantação e Testes</h1>

                <p>Este manual conduz a preparação completa do ambiente: pré-requisitos, configuração de certificados/hostnames, subida da stack com Docker Compose, testes de ingestão, verificação de observabilidade e geração do relatório final.</p>

                <h2>1. Objetivos</h2>
                <ul>
                    <li>Disponibilizar API, Worker, RabbitMQ, PostgreSQL, Redis, OpenTelemetry Collector, Prometheus, Grafana (com renderer) e Reporting Service.</li>
                    <li>Validar ingestão assíncrona (upload → fila → processamento → persistência).</li>
                    <li>Confirmar métricas/dashboards e gerar relatório consolidado.</li>
                </ul>

                <h2>2. Pré-requisitos</h2>
                <ul>
                    <li>Windows 10/11 com PowerShell.</li>
                    <li>Docker Desktop (com Docker Compose v2).</li>
                    <li>Opcional:
                        <ul>
                            <li><code>.NET 9 SDK</code> — executar serviços fora do Docker, se necessário.</li>
                            <li>Node.js (<code>npx @mermaid-js/mermaid-cli</code>) — renderizar diagramas Mermaid.</li>
                        </ul>
                    </li>
                </ul>

                <h2>3. Estrutura do Repositório</h2>
                <ul>
                    <li><code>src/</code> — projetos .NET (apps e libs).</li>
                    <li><code>scripts/</code> — utilitários (certificados, ingestão, diagramas).</li>
                    <li><code>docs/</code> — documentação segmentada em <code>architecture/</code>, <code>operations/</code> e <code>templates/</code>.</li>
                </ul>

                <h2>4. Preparação inicial</h2>
                <ol>
                    <li>Clone o repositório e abra PowerShell na raiz.</li>
                    <li>Gere certificados autoassinados:
                        <pre><code>scripts\certs\generate-dev-certs.cmd</code></pre>
                    </li>
                    <li>Configure hostnames locais (editar <code>C:\Windows\System32\drivers\etc\hosts</code> como Administrador):
                        <pre><code>127.0.0.1 api.local
127.0.0.1 reporting.local</code></pre>
                    </li>
                    <li>Garanta a existência da rede Docker:
                        <pre><code>docker network create docker-network</code></pre>
                    </li>
                </ol>

                <h2>5. Subir o stack com Docker Compose</h2>
                <ol>
                    <li>Dependências e observabilidade:
                        <pre><code>docker compose up -d postgres redis rabbitmq otel-collector prometheus grafana-renderer grafana</code></pre>
                    </li>
                    <li>Serviços de aplicação e proxy:
                        <pre><code>docker compose --profile proxy --profile api --profile worker --profile reporting up -d</code></pre>
                    </li>
                    <li>Conferir contêineres:
                        <pre><code>docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"</code></pre>
                    </li>
                </ol>

                <h2>6. Health checks rápidos</h2>
                <ul>
                    <li>Grafana: <code>http://localhost:3000</code></li>
                    <li>Prometheus: <code>http://localhost:9090</code></li>
                    <li>API via proxy: <code>https://api.local:8443/health</code></li>
                    <li>Reporting via proxy: <code>https://reporting.local:8444/health</code></li>
                </ul>
                <blockquote>Certificados são autoassinados: aceite o aviso do navegador ou importe os <code>.pem</code> gerados.</blockquote>

                <h2>7. Enviar jobs de ingestão</h2>
                <ol>
                    <li><strong>(Opcional)</strong> Gerar arquivo CSV grande:
                        <pre><code># Modo interativo
scripts\ingestion\gerar-csv-grande.cmd

# Com tamanho em MB
scripts\ingestion\gerar-csv-grande.cmd -TamanhoMB 100</code></pre>
                        <p>O arquivo é salvo em <code>files/large-test-data.csv</code>.</p>
                    </li>
                    <li>Gerar parâmetros com o batch:
                        <pre><code>scripts\ingestion\gera-parametros.bat</code></pre>
                    </li>
                    <li>Enviar o arquivo:
                        <pre><code>curl -k -X POST https://api.local:8443/ingestion/jobs \
     -F "file=@files/sample-data.csv" \
     -F "clientId=cliente-demo" \
     -F "fileType=csv" \
     -F "checksum=<INSIRA O HASH>"</code></pre>
                    </li>
                    <li>Verificar status:
                        <pre><code>curl -k https://api.local:8443/ingestion/jobs/{id}</code></pre>
                    </li>
                </ol>

                <h2>8. Observabilidade</h2>
                <ul>
                    <li>Prometheus (exemplos):
                        <pre><code>histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="dataflow-api"}[5m])) by (le))</code></pre>
                        <pre><code>sum by(status) (rate(http_requests_total{job="dataflow-api"}[5m]))</code></pre>
                    </li>
                    <li>Grafana: dashboards provisionados em <code>http://localhost:3000</code> (exporte PNG pelo renderer).</li>
                    <li>OTEL Collector: métricas em <code>http://localhost:8889/metrics</code>.</li>
                </ul>

                <h2>9. Capturar evidências</h2>
                <ul>
                    <li>Siga <code>docs/operations/screenshots/README.md</code> (nomenclatura <code>YYYYMMDD-HHMM-descricao.png</code>).</li>
                    <li>Armazene em <code>docs/operations/screenshots/</code>.</li>
                </ul>

                <h2>10. Gerar relatório final</h2>
                <p><strong>Automático via ReportingService:</strong></p>
                <pre><code>$body = @{ job = "dataflow-api"; window = "5m"; outputDir = "docs" } | ConvertTo-Json
Invoke-RestMethod -Method Post -Uri https://reporting.local:8444/reports/final -Body $body -ContentType "application/json" -SkipCertificateCheck</code></pre>
                <p>Resultado: <code>docs/RELATORIO-FINAL-&lt;timestamp&gt;.md</code>.</p>
                <p><strong>Manual:</strong> utilize <code>docs/templates/modelo-relatorio-final.md</code>.</p>

                <h2>11. Diagramas (opcional)</h2>
                <pre><code>scripts\diagrams\render_mermaid_diagram.cmd</code></pre>

                <h2>12. Critérios de aceite (referência)</h2>
                <ul>
                    <li>Latência p95 ≤ 500 ms.</li>
                    <li>Erros 5xx &lt; 1%.</li>
                    <li>Requests ativos estáveis.</li>
                </ul>

                <h2>13. Troubleshooting</h2>
                <ul>
                    <li>Portas ocupadas → ajuste mapeamentos no <code>docker-compose.yml</code> ou libere via <code>Get-NetTCPConnection</code>.</li>
                    <li>Renderer do Grafana falhando → reinicie <code>grafana</code> e <code>grafana-renderer</code>; confirme variáveis <code>GF_RENDERING_*</code>.</li>
                    <li>Sem métricas → verifique <code>otel-collector</code> e scrapes do Prometheus.</li>
                    <li>Fila não consumida → analise logs do <code>data-flow-worker</code> e credenciais do RabbitMQ.</li>
                </ul>

                <h2>14. FAQ rápido</h2>
                <ul>
                    <li><strong>Como subir tudo rapidamente?</strong> — siga seções 4/5 e execute os comandos indicados.</li>
                    <li><strong>Preciso de algo além do Docker?</strong> — opcionalmente .NET SDK e Node.js/Mermaid para diagramas.</li>
                    <li><strong>Onde ficam as métricas?</strong> — Grafana (<code>http://localhost:3000</code>) e Prometheus (<code>http://localhost:9090</code>).</li>
                    <li><strong>Como gerar o relatório?</strong> — endpoint <code>POST /reports/final</code> ou modelos em <code>docs/templates/</code>.</li>
                    <li><strong>Quero rodar fora do Docker. O que fazer?</strong> — consulte <code>docs/operations/tutoriais/run-outside-docker.md</code>.</li>
                </ul>

                <h2>15. Referências</h2>
                <ul>
                    <li><code>docs/README.md</code> — visão geral da documentação.</li>
                    <li><code>docs/architecture/dataflow-technical-architecture.md</code> — arquitetura detalhada.</li>
                    <li><code>docs/operations/tutoriais/endpoints-dataflow.md</code> — uso dos endpoints.</li>
                    <li><code>docker-compose.yml</code> — orquestração do stack.</li>
                </ul>

            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <h3>DataFlow</h3>
                    <p>Plataforma de Ingestão e Processamento de Dados</p>
                </div>
                <div class="footer-links">
                    <a href="../index.html#home">Início</a>
                    <a href="../index.html#arquitetura">Arquitetura</a>
                    <a href="../index.html#operacoes">Operações</a>
                    <a href="../index.html#tutoriais">Tutoriais</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 DataFlow - Portal de Documentação. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <script src="../js/main.js"></script>
</body>
</html>
